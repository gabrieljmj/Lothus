"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function routeHasParameters(e){var t=e.split("/"),r=!1;return t.forEach(function(e){":"===e.substr(0,1)&&(r=!0)}),r}function changePageTitle(e,t){t=t||document,t.title=e||t.title}var _typeof="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(e){return typeof e}:function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol?"symbol":typeof e},_createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var o=t[r];o.enumerable=o.enumerable||!1,o.configurable=!0,"value"in o&&(o.writable=!0),Object.defineProperty(e,o.key,o)}}return function(t,r,o){return r&&e(t.prototype,r),o&&e(t,o),t}}();Object.assign||Object.defineProperty(Object,"assign",{enumerable:!1,configurable:!0,writable:!0,value:function(e){if(void 0===e||null===e)throw new TypeError("Cannot convert first argument to object");for(var t=Object(e),r=1;r<arguments.length;r++){var o=arguments[r];if(void 0!==o&&null!==o){o=Object(o);for(var n=Object.keys(Object(o)),a=0,i=n.length;a<i;a++){var u=n[a],s=Object.getOwnPropertyDescriptor(o,u);void 0!==s&&s.enumerable&&(t[u]=o[u])}}}return t}});var Lothus=function(){function e(t){_classCallCheck(this,e),this.events={},this.dataBinder=rivets,this.router=new Navigo(null,(!1)),this._document=t||document,this._providers={},this._originalProviders={},this._routes={},this._lastRoute,this._lastProvider,this._defaultRoute}return _createClass(e,[{key:"init",value:function(){var e=this;return new Promise(function(t){var r=e._document.querySelectorAll("page[name][route]"),o=e._document.querySelectorAll("page[name][route][default]"),n={};if(!o.length||o.length>1)throw new Error("An unique default page is necessary. "+o.length+" indicated");o=o[0],r.forEach(function(t){var r=e._getOptions(t);t.attributes.regexRoute;e._routes[r.name]=r;var a=t.attributes.name.value,i=t.attributes.route.value;if(n[i]={as:a,uses:function(t){var o=e;if(t=t||{},r.dataProvider)e._providers[r.dataProvider]||(e._providers[r.dataProvider]={}),e.provider(r.dataProvider,{_params:t});else{var n="__for_"+a;e.provider(n,{_params:t}),r.dataProvider=n}e._handleRoute(r).then(function(e){changePageTitle(e.title,o._document),o._document.querySelectorAll("page[name][route]").forEach(function(t){t.style.display=t.attributes.name.value!==e.name?"none":""})})}},t===o){if(routeHasParameters(i))throw new Error("Default route must not have parameters.");e._defaultRoute=a}}),e.router.on(n),e._applyEvents(),e._initRouter(),t()})}},{key:"provider",value:function(e,t){if("object"!==("undefined"==typeof t?"undefined":_typeof(t)))throw new Error("Data providers can only be objects");this._providers[e]||(this._providers[e]={});var r=Object.assign(this._providers[e],t);if(!this._originalProviders[e]){this._originalProviders[e]={};for(var o in r)r.hasOwnProperty(o)&&(this._originalProviders[e][o]=r[o])}this._providers[e]=r}},{key:"_applyEvents",value:function(){var e=this;window.onhashchange=function(){window.history.pushState&&window.history.pushState(null,null,window.location.href),e._initRouter()}}},{key:"_initRouter",value:function(){this.router.resolve(),""!==window.location.hash&&"#"!==window.location.hash||this._renderDefaultRoute()}},{key:"_renderDefaultRoute",value:function(){window.location.hash="#"+this._routes[this._defaultRoute].route}},{key:"_render",value:function(e){if(e&&e.dataProvider){var t=this._providers[e.dataProvider];this._lastProvider=e.dataProvider,this.dataBinder.bind(this._document.querySelector('page[name="'+e.name+'"]'),t)}}},{key:"_getOptions",value:function(e){var t={name:e.attributes.name.value,route:e.attributes.route.value,clone:e.cloneNode(!0)};if(e.attributes["data-provider"]&&(t.dataProvider=e.attributes["data-provider"].value),e.attributes.origin&&(t.origin=e.attributes.origin.value),e.attributes.title&&(t.title=e.attributes.title.value),e.attributes.onload){if(!this.events[e.attributes.onload.value])throw new Error("Event for "+e.attributes.route.value+"::onload not found: "+e.attributes.onload.value);t.onload=e.attributes.onload.value}if(e.attributes.onunload){if(!this.events[e.attributes.onunload.value])throw new Error("Event for "+e.attributes.route.value+"::onunload not found: "+e.attributes.onunload.value);t.onunload=e.attributes.onunload.value}return t}},{key:"_handleRoute",value:function(e){var t=this;return new Promise(function(r){var o=e;window.location.href;t._handleEvent(o).onunload(),o.origin?!function(){var e=t;importTemplate(o.origin).then(function(t){e._document.querySelector('page[name="'+o.name+'"]').innerHTML=t.body.innerHTML,e._render(o),e._handleEvent(o).onload()})}():(t._render(o),t._handleEvent(o).onload()),r(o)})}},{key:"_handleEvent",value:function(e){var t=this,r=this._document.querySelector('page[name="'+e.name+'"]');return{onload:function(){e.onload&&t.events[e.onload].bind(r,t._providers[e.dataProvider]._params).call()},onunload:function(){if(t._lastRoute){t._routes[t._lastRoute].onunload&&t.events[t._routes[t._lastRoute].onunload].call();var r=t._routes[t._lastRoute];t._document.querySelector('page[name="'+r.name+'"]').innerHTML=r.clone.innerHTML}t._lastProvider&&(t._providers[t._lastProvider]=t._originalProviders[t._lastProvider]),t._lastRoute=e.name}}}}]),e}();"object"===("undefined"==typeof module?"undefined":_typeof(module))?module.exports=Lothus:"object"===("undefined"==typeof exports?"undefined":_typeof(exports))&&(exports.Lothus=Lothus);